#' PWS Storage
#' @docType class
#' @author Maruthi Ram Nadakuduru, Jared Casale
#' @description This class holds the result of a WUnderground API query. The parameters imply
#' the query used (i.e. if zip is set, a zip lookup was performed) and the resulting stations
#' are stored in a stations data table.
#' @importFrom R6 R6Class
#' @format An \code{\link{R6Class}} generator object
#' @keywords PWS, Wunderground
#' @seealso \code{\link{getStations}} for a method that will generate an object. See \code{\link{loadWeatherData}} to load weather data for the selected PWS stations.
PWStations <- R6::R6Class("PWStations",
  public = list(
    latlong = NA,
    zip = NA,
    state = NA,
    country = NA,
    city = NA,
    radius = NA,
    queryArg = NA,
    stations = NA,
    weatherData = NA,
    initialize = function(latlong = NA, zip = NA, state = NA, country = NA, city = NA, radius = NA) {
      if (all(is.na(latlong),
              is.na(zip),
              is.na(country),
              is.na(city))) {
        stop("A valid location must be specified.")
      }

      # Radius must be numeric if specified
      if (!is.na(radius) && !is.numeric(radius)) {
        stop("Radius must be numeric.")
      }

      # Check the bounds and default to just outside the max (25)
      if (is.na(radius) || radius < 0 || radius > 24) {
        radius <- 25
      }

      # Build the query argument as we check
      queryArg <- NA

      # Check latlong
      if (!is.na(latlong)) {
        # Lat/long specified
        if (!is.numeric(latlong) || length(latlong) != 2) {
          stop("Latlong must be two numeric values.")
        }

        queryArg <- paste0(latlong[1], ",", paste[2])
      }

      # Check zipcode
      if (!is.na(zip)) {
        if (!is.na(queryArg)) {
          stop("Please specify a single location parameter (latlong, zipcode, state/city or country/city.")
        }

        if (!is.character(zip) || nchar(zip) != 5 || !any(zipcodes[zipcodes$zip == zip, 1])) {
          stop("Please specify a valid zipcode string.")
        }

        queryArg <- zip
      }

      # Check for a city (since we require it for state OR country)
      if (!is.na(city)) {
        if (!is.na(queryArg)) {
          stop("Please specify a single location parameter (latlong, zipcode, state/city or country/city.")
        }

        if (!is.character(city)) {
          stop("Please specify city as a chracter string.")
        }

        # Don't build the arg just yet
      }

      # Check for a state
      if (!is.na(state)) {
        if (!is.na(queryArg)) {
          stop("Please specify a single location parameter (latlong, zipcode, state/city or country/city.")
        }

        if (!is.character(state) || nchar(state) != 2) {
          stop("Please specify state as a length 2 chracter string.")
        }

        queryArg <- paste0(state, "/", city)
      }

      # Check for a country
      if (!is.na(country)) {
        if (!is.na(queryArg)) {
          stop("Please specify a single location parameter (latlong, zipcode, state/city or country/city.")
        }

        if (!is.character(country)) {
          stop("Please specify country as a chracter string.")
        }

        queryArg <- paste0(country, "/", city)
      }

      self$latlong <- latlong
      self$zip <- zip
      self$state <- state
      self$country <- country
      self$city <- city
      self$radius <- radius
      self$queryArg <- queryArg
    }
  )
)